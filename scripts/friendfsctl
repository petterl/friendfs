#!/bin/sh 

FFS_ROOT=.
ERL_COOKIE=friendfs
ERL_SNAME=friendfs
ERL_CALL=erl_call
ROOTDIR=`cd $(dirname $0)/..;pwd`
if [ -z "$RELDIR" ]; then
    RELDIR=$ROOTDIR/releases
fi
FRIENDFS_CONF=${FRIENDFS_CONF:-/etc/friendfs.conf}

function check() {
    # Check validity of config file
    if [ ! -f $1 ]; then
        echo "Configuration file \"$1\" missing!"
        exit 1
    fi
}

function start() {
    check $FRIENDFS_CONF
    START_ERL_DATA=${1:-$RELDIR/start_erl.data}
    $ROOTDIR/bin/run_erl -daemon $ROOTDIR/pipes/ $ROOTDIR/log "exec $ROOTDIR/bin/start_erl $ROOTDIR $RELDIR $START_ERL_DATA -pa $ROOTDIR/patches/ -sname friendfs -setcookie friendfs -friendfs config_path '\"$FRIENDFS_CONF\"' " 
}

function stop() {
    $ERL_CALL -c $ERL_COOKIE -sname $ERL_SNAME -a "init stop []"
}

function restart() {
    stop
    sleep 1
    start
}

function connect() {
    $FFS_ROOT/bin/to_erl $FFS_ROOT/pipes/
}

function help() {
    echo "The valid commands are: "
    echo "   start - start the friendfs daemon"
    echo "   stop - stop the friendfs daemon"
    echo "   restart - restart the friendfs daemon"
    echo "   connect - connect to the friendfs daemon"
    echo ""
    echo "To mount a filesystem see 'friendfs'"
}

case $1 in
    'start') start ;;
    'stop') stop ;;
    'restart') restart ;;
    'connect') connect ;;
    *) echo "$1 is not a valid command"
       help ;;
esac

